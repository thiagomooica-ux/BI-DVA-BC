<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DVA ‚Ä¢ BI P√≥s-Vendas (Funcional)</title>

  <link rel="icon" type="image/png" href="favicon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            display: ['Montserrat', 'sans-serif'],
          },
          colors: {
            jeep: '#FFBA00',
            ram: '#B81822',
            dark: {
              950: '#020617',
              900: '#0f172a',
              800: '#1e293b',
            }
          },
          boxShadow: {
            'glow-gold': '0 0 20px rgba(250, 204, 21, 0.3)',
            'glow-red': '0 0 20px rgba(184, 24, 34, 0.3)',
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
    
    main { -webkit-overflow-scrolling: touch; }
h1, h2, h3, .font-display { font-family: 'Montserrat', sans-serif; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    /* Glass Effect */
    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .glass-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }
    .glass-card:hover { border-color: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }

    /* Animations */
    .fade-in { animation: fadeIn 0.3s ease-out both; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform:none;} }
    
    .loading-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
  </style>
</head>

<body class="antialiased min-h-screen flex flex-col md:flex-row overflow-hidden h-screen">

  <aside class="w-full md:w-64 bg-dark-900 border-r border-white/5 flex flex-col justify-between z-50 md:h-screen fixed md:relative bottom-0 md:bottom-auto glass-panel">
    <div class="hidden md:flex flex-col items-center justify-center h-24 border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 bg-white rounded flex items-center justify-center text-black font-black font-display text-xl">D</div>
        <span class="text-xl font-display font-bold text-white tracking-widest">DVA<span class="text-jeep">.BI</span></span>
      </div>
      <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">P√≥s-Vendas Manager</p>
    </div>

    <nav class="flex-1 flex md:flex-col justify-around md:justify-start md:p-4 gap-2">
      <button class="nav-btn flex flex-col md:flex-row items-center md:gap-3 p-3 md:px-4 md:py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all w-full group"
              data-action="tab" data-tab="dashboard">
        <i class="fa-solid fa-chart-pie text-lg md:text-sm group-[.active]:text-jeep"></i>
        <span class="text-[10px] md:text-sm font-semibold md:mt-0 group-[.active]:text-white">Dashboard</span>
      </button>

      <button class="nav-btn flex flex-col md:flex-row items-center md:gap-3 p-3 md:px-4 md:py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all w-full group"
              data-action="tab" data-tab="dados">
        <i class="fa-solid fa-table-list text-lg md:text-sm group-[.active]:text-jeep"></i>
        <span class="text-[10px] md:text-sm font-semibold md:mt-0 group-[.active]:text-white">Dados & Metas</span>
      </button>
      <button class="nav-btn flex flex-col md:flex-row items-center md:gap-3 p-3 md:px-4 md:py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all w-full group"
              data-action="tab" data-tab="campanhas">
        <i class="fa-solid fa-trophy text-lg md:text-sm group-[.active]:text-jeep"></i>
        <span class="text-[10px] md:text-sm font-semibold md:mt-0 group-[.active]:text-white">Campanhas</span>
      </button>


      <button class="nav-btn flex flex-col md:flex-row items-center md:gap-3 p-3 md:px-4 md:py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all w-full group"
              data-action="tab" data-tab="config">
        <i class="fa-solid fa-gear text-lg md:text-sm group-[.active]:text-jeep"></i>
        <span class="text-[10px] md:text-sm font-semibold md:mt-0 group-[.active]:text-white">Config</span>
      </button>
    </nav>
  </aside>

  <main class="flex-1 min-h-0 overflow-y-auto relative pb-32 md:pb-0 bg-dark-950">
    <div class="md:hidden flex items-center justify-between p-4 bg-dark-900/90 backdrop-blur sticky top-0 z-40 border-b border-white/5">
      <span class="text-lg font-display font-bold text-white">DVA<span class="text-jeep">.BI</span></span>
      <div id="mobileMonthDisplay" class="text-xs font-bold text-slate-300 bg-white/10 px-2 py-1 rounded">--/--</div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
      
      <header class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
        <div>
          <h1 class="text-2xl md:text-3xl font-display font-black text-white tracking-tight">Vis√£o Geral <span class="text-transparent bg-clip-text bg-gradient-to-r from-jeep to-ram">2026</span></h1>
          <p class="text-sm text-slate-400 mt-1">Acompanhamento de performance e proje√ß√£o de fechamento.</p>
        </div>

        <div class="flex items-center gap-3">
          <div class="bg-dark-900 border border-white/10 rounded-xl px-3 py-2 flex items-center gap-2">
            <i class="fa-regular fa-calendar text-jeep text-xs"></i>
            <select id="monthSelect" class="bg-transparent text-sm text-white font-bold outline-none cursor-pointer">
              </select>
          </div>
          <div class="bg-dark-900 border border-white/10 rounded-xl px-3 py-2">
             <span id="lastUpdateText" class="text-[10px] text-slate-400 font-mono">Atualizado: --:--</span>
          </div>
        </div>
      </header>

      <section id="tab-dashboard" class="tab-content space-y-6 fade-in">
        
        
        <div id="fatHeroCard" class="glass-card rounded-3xl p-6 md:p-8 relative overflow-hidden border border-white/5">
          <div class="absolute top-0 right-0 -mr-24 -mt-24 w-96 h-96 bg-jeep/6 rounded-full blur-3xl pointer-events-none"></div>
          <div class="absolute bottom-0 left-0 -ml-32 -mb-32 w-[28rem] h-[28rem] bg-ram/6 rounded-full blur-3xl pointer-events-none"></div>

          <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6 relative z-10">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-3 mb-2">
                <h2 class="text-xs font-bold uppercase tracking-widest text-slate-500">Faturamento Total</h2>
                <span id="fatStatusBadge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Calculando...</span>
                <span id="fatTimeHint" class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">‚Äî</span>
              </div>

              <div class="flex flex-wrap items-baseline gap-x-3 gap-y-2 min-w-0">
                <span id="fatRealBig" class="min-w-0 max-w-full tabular-nums text-[clamp(2.4rem,9vw,4.6rem)] md:text-[clamp(3.0rem,5vw,4.8rem)] leading-[0.95] font-display font-black text-white tracking-tighter break-words">R$ 0</span>
                <span class="text-sm text-slate-400 font-bold">Meta:</span>
                <span id="fatMetaBig" class="text-sm text-slate-300 font-black">R$ 0</span>
                <span class="text-xs text-slate-600 font-bold">‚Ä¢</span>
                <span class="inline-flex items-baseline gap-2 whitespace-nowrap"><span class="text-sm text-slate-400 font-bold">Atingido:</span><span id="fatPctBig" class="text-sm text-slate-200 font-black">0%</span></span>
              </div>

              <div class="mt-4">
                <div class="flex items-center justify-between text-[10px] uppercase font-bold text-slate-600 tracking-widest mb-2">
                  <span>0%</span>
                  <span>100%</span>
                </div>
                <div class="h-1.5 w-full bg-dark-950 rounded-full mb-3 relative overflow-hidden">
                  <div id="fatBarFill" class="h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                  <div id="fatIdealMarker" class="absolute top-0 h-full w-0.5 bg-white shadow-[0_0_5px_white]" style="left: 0%" title="Ritmo ideal (meta proporcional aos dias √∫teis)"></div>
                </div>
                <p class="mt-2 text-[10px] text-slate-600 flex items-center gap-2">
                  <i class="fa-solid fa-location-dot text-jeep"></i>
                  <span>Marcador branco = ritmo ideal hoje (dias √∫teis). Se o preenchimento estiver antes, voc√™ est√° atrasado no ritmo; se estiver depois, adiantado.</span>
                </p>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4 w-full lg:w-[36rem] xl:w-[38rem]">
              <div class="glass-panel rounded-2xl p-3.5 border border-white/5 min-w-0">
                <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Ritmo ideal hoje</p>
                <p id="fatExpectedBig" class="min-w-0 max-w-full tabular-nums whitespace-nowrap tracking-tight text-[clamp(1.05rem,2.0vw,1.35rem)] md:text-[clamp(1.10rem,1.6vw,1.40rem)] lg:text-[1.28rem] xl:text-[1.32rem] leading-none font-display font-black text-white">R$ 0</p>
                <p class="text-[10px] text-slate-600 font-bold">meta √ó % dias √∫teis</p>
              </div>

              <div class="glass-panel rounded-2xl p-3.5 border border-white/5 min-w-0">
                <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Proje√ß√£o m√™s</p>
                <p id="fatProjBig" class="min-w-0 max-w-full tabular-nums whitespace-nowrap tracking-tight text-[clamp(1.05rem,2.0vw,1.35rem)] md:text-[clamp(1.10rem,1.6vw,1.40rem)] lg:text-[1.28rem] xl:text-[1.32rem] leading-none font-display font-black text-white">R$ 0</p>
                <p class="text-[10px] text-slate-600 font-bold">realizado/dia √∫til √ó dias √∫teis</p>
              </div>

              <div class="glass-panel rounded-2xl p-3.5 border border-white/5 min-w-0">
                <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Gap (meta ‚àí proje√ß√£o)</p>
                <p id="fatGapBig" class="min-w-0 max-w-full tabular-nums whitespace-nowrap tracking-tight text-[clamp(1.05rem,2.0vw,1.35rem)] md:text-[clamp(1.10rem,1.6vw,1.40rem)] lg:text-[1.28rem] xl:text-[1.32rem] leading-none font-display font-black text-ram">R$ 0</p>
                <p class="text-[10px] text-slate-600 font-bold">quanto falta pela proje√ß√£o</p>
              </div>

              <div class="glass-panel rounded-2xl p-3.5 border border-white/5 min-w-0">
                <p class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Necess√°rio / dia √∫til</p>
                <p id="fatNeededBig" class="min-w-0 max-w-full tabular-nums whitespace-nowrap tracking-tight text-[clamp(1.05rem,2.0vw,1.35rem)] md:text-[clamp(1.10rem,1.6vw,1.40rem)] lg:text-[1.28rem] xl:text-[1.32rem] leading-none font-display font-black text-jeep">R$ 0</p>
                <p class="text-[10px] text-slate-600 font-bold">para bater a meta</p>
              </div>
            </div>
          </div>
        </div>


        <div id="kpiCards" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          </div>
      </section>

      <section id="tab-dados" class="tab-content hidden space-y-6 fade-in pb-10">
        <div class="glass-card rounded-3xl overflow-hidden">
          <div class="p-6 border-b border-white/5 flex justify-between items-center bg-dark-900/50">
            <div>
              <h2 class="text-lg font-display font-bold text-white">Entrada de Dados</h2>
              <p class="text-xs text-slate-400">Atualize aqui o realizado do dia.</p>
            </div>
            <button data-action="save-all" class="bg-jeep hover:bg-yellow-400 text-black px-6 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all shadow-[0_0_15px_rgba(255,186,0,0.4)] flex items-center gap-2">
              <i class="fa-solid fa-save"></i> Salvar Altera√ß√µes
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-white/5 text-[10px] uppercase font-bold text-slate-400 tracking-wider">
                <tr>
                  <th class="px-6 py-4">KPI</th>
                  <th class="px-6 py-4">Meta (R$/Qtd)</th>
                  <th class="px-6 py-4">Realizado (Acumulado)</th>
                </tr>
              </thead>
              <tbody id="dataTableBody" class="divide-y divide-white/5 text-sm">
                </tbody>
            </table>
          </div>
          
          <div class="p-4 bg-jeep/10 text-jeep text-xs font-medium text-center">
            Dica: Os valores s√£o salvos automaticamente no seu navegador.
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button data-action="export-json" class="p-4 rounded-2xl bg-dark-900 border border-white/10 hover:border-jeep/50 text-slate-300 hover:text-white transition-all text-xs font-bold uppercase flex items-center justify-center gap-2">
            <i class="fa-solid fa-download"></i> Backup dos Dados
          </button>

          <label class="p-4 rounded-2xl bg-dark-900 border border-white/10 hover:border-white/30 text-slate-300 hover:text-white transition-all text-xs font-bold uppercase flex items-center justify-center gap-2 cursor-pointer">
            <i class="fa-solid fa-upload"></i> Restaurar Backup
            <input type="file" id="importFile" class="hidden" accept=".json">
          </label>

          <label class="p-4 rounded-2xl bg-dark-900 border border-white/10 hover:border-white/30 text-slate-300 hover:text-white transition-all text-xs font-bold uppercase flex items-center justify-center gap-2 cursor-pointer">
            <i class="fa-solid fa-file-arrow-up"></i> Upload Planilha (ODS/XLSX/CSV)
            <input type="file" id="sheetFile" class="hidden" accept=".ods,.fods,.xlsx,.xls,.csv">
          </label>
        </div>
      </section>

      <section id="tab-config" class="tab-content hidden space-y-6 fade-in">
        <div class="glass-card rounded-3xl p-6">
          <h2 class="text-lg font-display font-bold text-white mb-6">Regras do Calend√°rio</h2>
          
          <div class="space-y-4">
            <label class="flex items-center justify-between p-4 rounded-xl bg-dark-950 border border-white/5 cursor-pointer">
              <span class="text-sm font-bold text-white">Considerar S√°bados como √öteis</span>
              <input type="checkbox" id="toggleSat" class="w-5 h-5 accent-jeep rounded bg-dark-800 border-white/20">
            </label>

            <label class="flex items-center justify-between p-4 rounded-xl bg-dark-950 border border-white/5 cursor-pointer">
              <span class="text-sm font-bold text-white">Pontos Facultativos (Carnaval/Corpus)</span>
              <input type="checkbox" id="toggleOptional" class="w-5 h-5 accent-jeep rounded bg-dark-800 border-white/20">
            </label>
            
            <div class="p-4 rounded-xl bg-dark-950 border border-white/5">
              <p class="text-sm font-bold text-white mb-2">Feriados Locais</p>
              <div class="flex gap-2 mb-3">
                <input id="holidayInput" type="text" placeholder="AAAA-MM-DD" class="bg-dark-900 border border-white/10 rounded-lg px-3 py-2 text-sm text-white w-full">
                <button data-action="add-holiday" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-white"><i class="fa-solid fa-plus"></i></button>
              </div>
              <div id="holidayList" class="space-y-2 text-xs"></div>
            </div>
          </div>
        </div>
      </section>
      <section id="tab-campanhas" class="tab-content hidden space-y-6 fade-in pb-10">

        <div id="fatHeroCard" class="glass-card rounded-3xl p-6 md:p-8 relative overflow-hidden border border-white/5">
          <div class="absolute top-0 right-0 -mr-24 -mt-24 w-96 h-96 bg-jeep/5 rounded-full blur-3xl pointer-events-none"></div>
          <div class="absolute bottom-0 left-0 -ml-28 -mb-28 w-[28rem] h-[28rem] bg-ram/5 rounded-full blur-3xl pointer-events-none"></div>

          <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4 relative z-10">
            <div>
              <h2 class="text-xl md:text-2xl font-display font-black text-white tracking-tight">
                Gest√£o de Campanhas <span class="text-transparent bg-clip-text bg-gradient-to-r from-jeep to-ram">Q1 2026</span>
              </h2>
              <p class="text-sm text-slate-400 mt-1">
                Consulta r√°pida por setor ‚Ä¢ Per√≠odo: 01/01/2026 a 31/03/2026
              </p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
              <div class="bg-dark-900 border border-white/10 rounded-2xl px-4 py-3 flex items-center gap-3">
                <div class="text-[10px] uppercase font-black tracking-widest text-slate-500">Modo</div>
                <div class="flex items-center gap-2">
                  <button id="campBtnCompact" class="px-3 py-1.5 rounded-xl text-xs font-black uppercase tracking-wider bg-white/5 hover:bg-white/10 transition border border-white/10">Compacto</button>
                  <button id="campBtnDetalhado" class="px-3 py-1.5 rounded-xl text-xs font-black uppercase tracking-wider bg-white/5 hover:bg-white/10 transition border border-white/10">Detalhado</button>
                </div>
              </div>

              <div class="bg-dark-900 border border-white/10 rounded-2xl px-4 py-3 flex items-center gap-2">
                <i class="fa-solid fa-magnifying-glass text-slate-500 text-sm"></i>
                <input id="campSearchInput" class="bg-transparent outline-none text-sm text-white placeholder:text-slate-600 w-60" placeholder="Buscar: 89, base 80, Ram, BEE..." />
              </div>

              <div class="flex items-center gap-2">
                <button id="campBtnCopyResumo" class="bg-white/10 hover:bg-white/20 border border-white/10 text-white px-4 py-3 rounded-2xl text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2">
                  <i class="fa-regular fa-copy"></i> Copiar
                </button>
                <button id="campBtnPrint" class="bg-white/10 hover:bg-white/20 border border-white/10 text-white px-4 py-3 rounded-2xl text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2">
                  <i class="fa-solid fa-print"></i> Imprimir
                </button>
              </div>
            </div>
          </div>

          <!-- Mobile sector pills -->
          <div class="mt-5 md:hidden">
            <div class="text-[10px] uppercase font-black tracking-widest text-slate-500 mb-2">Setores</div>
            <div id="campNavMobile" class="flex gap-2 overflow-x-auto pb-2 scrollbar"></div>
          </div>

          <div class="mt-6 grid grid-cols-1 xl:grid-cols-12 gap-6">
            <!-- Sector nav (desktop) -->
            <aside class="hidden md:block xl:col-span-4">
              <div class="glass-panel rounded-3xl p-4 border border-white/5">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <div class="text-[10px] uppercase font-black tracking-widest text-slate-500">Navega√ß√£o</div>
                    <div class="text-sm font-display font-bold text-white">Setores</div>
                  </div>
                  <div class="text-[10px] font-mono text-slate-500" id="campActiveIdLabel">‚Äî</div>
                </div>
                <div class="space-y-2" id="campNav"></div>

                <div class="mt-4 p-3 rounded-2xl bg-dark-950 border border-white/5">
                  <div class="text-xs font-bold text-slate-300 mb-2">Notas importantes</div>
                  <ul class="text-xs text-slate-500 space-y-1.5">
                    <li>‚Ä¢ Incentivo pago via folha/cart√£o/BEE, sem incorpora√ß√£o salarial.</li>
                    <li>‚Ä¢ Metas podem ser revisadas se a montadora alterar objetivos de NPS.</li>
                  </ul>
                </div>
              </div>
            </aside>

            <!-- Main details -->
            <div class="xl:col-span-8 space-y-5">
              <div class="glass-panel rounded-3xl p-5 border border-white/5">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                  <div>
                    <div class="flex flex-wrap items-center gap-2">
                      <h3 id="campSectorTitle" class="text-lg md:text-xl font-display font-black text-white tracking-tight">‚Äî</h3>
                      <div class="flex flex-wrap gap-2" id="campBadges"></div>
                    </div>
                    <p id="campSectorSubtitle" class="text-sm text-slate-400 mt-1">‚Äî</p>
                  </div>
                </div>

                <div id="campKpiGrid" class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
              </div>

              <div class="grid grid-cols-1 xl:grid-cols-12 gap-5">
                <div class="xl:col-span-7 space-y-5">
                  <div class="glass-panel rounded-3xl p-5 border border-white/5">
                    <div class="flex items-center justify-between">
                      <h4 class="text-sm font-display font-bold text-white">Regras de meta e elegibilidade</h4>
                      <span id="campRulesCount" class="text-xs font-mono text-slate-500">‚Äî</span>
                    </div>
                    <div id="campRulesList" class="mt-4 space-y-2"></div>
                  </div>

                  <div class="glass-panel rounded-3xl p-5 border border-white/5">
                    <div class="flex items-center justify-between">
                      <h4 class="text-sm font-display font-bold text-white">Premia√ß√£o</h4>
                      <span id="campPremiosHint" class="text-xs font-mono text-slate-500">‚Äî</span>
                    </div>
                    <div id="campPremiosGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                  </div>
                </div>

                <div class="xl:col-span-5 space-y-5">
                  <div class="glass-panel rounded-3xl p-5 border border-white/5">
                    <h4 class="text-sm font-display font-bold text-white">Calend√°rio & pagamentos</h4>
                    <div id="campTimeline" class="mt-4 space-y-3"></div>
                  </div>

                  <div id="campExtrasBox" class="glass-panel rounded-3xl p-5 border border-white/5">
                    <h4 class="text-sm font-display font-bold text-white">Observa√ß√µes operacionais</h4>
                    <ul id="campExtrasList" class="mt-4 text-sm text-slate-300 space-y-2"></ul>
                    <div class="mt-3 text-[10px] text-slate-600">
                      * Organiza√ß√£o pr√°tica do que mais ‚Äúderruba‚Äù resultado; n√£o substitui a regra oficial.
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-[10px] text-slate-600 font-mono flex justify-between">
                <span id="campFooterLeft">‚Äî</span>
                <span>campanhas.v1 ‚Ä¢ offline</span>
              </div>
            </div>
          </div>
        </div>
      </section>


    </div>
  </main>

  <div id="toast" class="fixed bottom-20 md:bottom-6 right-6 z-[60] transform transition-all duration-300 translate-y-20 opacity-0 pointer-events-none">
    <div class="bg-white text-dark-950 px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 border-l-4 border-jeep">
      <i class="fa-solid fa-check-circle text-jeep"></i>
      <span id="toastMsg" class="text-sm font-bold">Salvo com sucesso!</span>
    </div>
  </div>

  <script>
    /* --- 1. ESTADO & DADOS INICIAIS --- */
    const STORAGE_KEY = "dva_bi_v3_fixed";

    /* --- 1.1 SUPABASE CLOUD SYNC (persist√™ncia entre PCs) --- */
    const SB_URL = "https://xibqbdgcyuszsrquaodp.supabase.co";
    const SB_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpYnFiZGdjeXVzenNycXVhb2RwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzkwOTMsImV4cCI6MjA4NzAxNTA5M30.mmHSTdRGgLSNJqb_cB1i3sf2kNa5INyMZB-LFd15Lpg";
    // Bucket e nomes fixos (compat√≠vel com seu padr√£o anterior "latest.xlsx do cloud")
    const SB_BUCKET = "cloud";
    const SB_OBJ_XLSX = "latest.xlsx";
    const SB_OBJ_STATE = "latest_state.json";
    const SB_TIMEOUT_MS = 15000;

    let _sb = null;

    function sbClient() {
      try {
        if (_sb) return _sb;
        if (!window.supabase) return null;
        _sb = window.supabase.createClient(SB_URL, SB_ANON_KEY);
        return _sb;
      } catch (e) {
        console.warn("Supabase init falhou:", e);
        return null;
      }
    }

    function withTimeout(promise, ms = SB_TIMEOUT_MS) {
      return Promise.race([
        promise,
        new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), ms))
      ]);
    }

    async function sbUpload(path, blob, contentType) {
      const sb = sbClient();
      if (!sb) throw new Error("Supabase n√£o dispon√≠vel");
      const { data, error } = await withTimeout(
        sb.storage.from(SB_BUCKET).upload(path, blob, {
          cacheControl: "0",
          upsert: true,
          contentType
        })
      );
      if (error) throw error;
      return data;
    }

    async function sbDownload(path) {
      const sb = sbClient();
      if (!sb) throw new Error("Supabase n√£o dispon√≠vel");
      const { data, error } = await withTimeout(sb.storage.from(SB_BUCKET).download(path));
      if (error) throw error;
      return data; // Blob
    }

    async function sbTryLoadRemoteState() {
      // Carrega estado salvo em nuvem (se existir) e aplica por cima do localStorage
      try {
        const blob = await sbDownload(SB_OBJ_STATE);
        const txt = await blob.text();
        const remote = JSON.parse(txt);

        // Valida√ß√£o m√≠nima para evitar quebrar se tiver lixo no bucket
        if (!remote || typeof remote !== "object" || !remote.data || !remote.config) {
          console.warn("Estado remoto inv√°lido, ignorando.");
          return false;
        }

        // Merge conservador
        state = {
          ...state,
          ...remote,
          config: { ...state.config, ...(remote.config || {}) },
          data: remote.data || state.data
        };

        // Persistir localmente
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        updateTimeDisplay();
        render();
        showToast("Dados carregados da nuvem.");
        return true;
      } catch (e) {
        // Silencioso (primeiro acesso pode n√£o ter arquivo remoto)
        console.warn("Sem estado remoto (ok):", e?.message || e);
        return false;
      }
    }

    async function sbSyncAfterUpload(wb) {
      // Salva: (1) planilha normalizada como XLSX e (2) estado do app em JSON
      const sb = sbClient();
      if (!sb) return;

      try {
        showToast("Salvando na nuvem...");
        // 1) XLSX (sempre latest.xlsx)
        const xlsxBuf = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const xlsxBlob = new Blob([xlsxBuf], {
          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });
        await sbUpload(SB_OBJ_XLSX, xlsxBlob, xlsxBlob.type);

        // 2) Estado JSON
        const payload = {
          ...state,
          __cloud: {
            savedAt: new Date().toISOString(),
            bucket: SB_BUCKET,
            file: SB_OBJ_XLSX,
            v: 1
          }
        };
        const jsonBlob = new Blob([JSON.stringify(payload)], { type: "application/json" });
        await sbUpload(SB_OBJ_STATE, jsonBlob, "application/json");

        // Atualiza rel√≥gio do header com base real
        state.__cloud = payload.__cloud;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        updateTimeDisplay();

        showToast("Planilha salva na nuvem (OK).");
      } catch (e) {
        console.error("Falha no sync Supabase:", e);
        showToast("Importado, mas falhou salvar na nuvem.");
      }
    }

    
    // Configura√ß√£o dos KPIs (fonte √∫nica para metas/realizado e c√°lculos)
    const KPIS_ALL = [
      { id: "faturamento", label: "Faturamento Total", type: "money", icon: "fa-sack-dollar" },
      { id: "passagens",   label: "Passagens Oficina", type: "count", icon: "fa-car" },
      { id: "mao_obra",    label: "M√£o de Obra",       type: "money", icon: "fa-wrench" }
    ];

    // KPIs exibidos no Dashboard (cards menores)
    // Troca solicitada: HERO = Faturamento Total (acima) e Ritmo do M√™s como card menor
    const KPIS_DASH = [
      { id: "pace",        label: "Ritmo do M√™s (Dias √öteis)", type: "pace", icon: "fa-gauge-high" },
      { id: "passagens",   label: "Passagens Oficina",         type: "count", icon: "fa-car" },
      { id: "mao_obra",    label: "M√£o de Obra",               type: "money", icon: "fa-wrench" }
    ];

    // Meses
    const MONTHS = [
      { id: "2026-01", label: "Janeiro 2026" }, { id: "2026-02", label: "Fevereiro 2026" },
      { id: "2026-03", label: "Mar√ßo 2026" },   { id: "2026-04", label: "Abril 2026" },
      { id: "2026-05", label: "Maio 2026" },    { id: "2026-06", label: "Junho 2026" },
      { id: "2026-07", label: "Julho 2026" },   { id: "2026-08", label: "Agosto 2026" },
      { id: "2026-09", label: "Setembro 2026" },{ id: "2026-10", label: "Outubro 2026" },
      { id: "2026-11", label: "Novembro 2026" },{ id: "2026-12", label: "Dezembro 2026" }
    ];

    // DADOS PR√â-CARREGADOS (Baseado na sua planilha/conversas anteriores)
    const DEFAULT_DATA = {
      metas: {
        faturamento: { "2026-01": 586857, "2026-02": 591643, "2026-03": 543528 },
        passagens:   { "2026-01": 272,    "2026-02": 266,    "2026-03": 250 },
        mao_obra:    { "2026-01": 199114, "2026-02": 199069, "2026-03": 169867 }
      },
      realizado: {
        faturamento: { "2026-01": 586857, "2026-02": 225000 }, // Exemplo Fev
        passagens:   { "2026-01": 272,    "2026-02": 105 },
        mao_obra:    { "2026-01": 199114, "2026-02": 75400 }
      }
    };

    let state = {
      month: "2026-02", // Inicia em Fevereiro
      config: { sat: false, optional: false, holidays: [] },
      data: JSON.parse(JSON.stringify(DEFAULT_DATA)) // Clone
    };

    /* --- 2. SISTEMA DE DATAS & C√ÅLCULOS --- */
    function getWorkdays(year, month) {
      // Feriados Nacionais Fixos
      const holidays = [`${year}-01-01`,`${year}-04-21`,`${year}-05-01`,`${year}-09-07`,`${year}-10-12`,`${year}-11-02`,`${year}-11-15`,`${year}-11-20`,`${year}-12-25`];
      
      // P√°scoa/Carnaval/Corpus (Simplificado para 2026 para brevidade, idealmente usa algoritmo de Gauss)
      if(year == 2026) {
        holidays.push("2026-04-03"); // Paix√£o de Cristo
        if(state.config.optional) {
          holidays.push("2026-02-16", "2026-02-17"); // Carnaval
          holidays.push("2026-06-04"); // Corpus
        }
      }
      // Feriados locais
      state.config.holidays.forEach(h => holidays.push(h));

      const lastDay = new Date(year, month, 0).getDate();
      const now = new Date();
      // Data de corte: Se m√™s passado, √∫ltimo dia. Se m√™s atual, hoje. Se futuro, dia 1.
      let cutoff = new Date(year, month - 1, 1);
      const isCurrentMonth = (now.getFullYear() == year && now.getMonth() + 1 == month);
      
      if (isCurrentMonth) cutoff = now;
      else if (now > new Date(year, month - 1, lastDay)) cutoff = new Date(year, month - 1, lastDay);
      
      let total = 0, elapsed = 0;
      
      for(let d=1; d<=lastDay; d++) {
        const date = new Date(year, month-1, d);
        const iso = date.toISOString().split('T')[0];
        const dayOfWeek = date.getDay(); // 0=Dom, 6=Sab
        
        let isWork = true;
        if(dayOfWeek === 0) isWork = false; // Domingo
        if(!state.config.sat && dayOfWeek === 6) isWork = false; // S√°bado
        if(holidays.includes(iso)) isWork = false;

        if(isWork) {
          total++;
          if(date <= cutoff) elapsed++;
        }
      }
      return { total, elapsed, remaining: total - elapsed, progress: total > 0 ? elapsed/total : 0, cutoff };
    }

    function calculateKPI(kpi, monthKey, wd) {
      const meta = state.data.metas[kpi][monthKey] || 0;
      const real = state.data.realizado[kpi][monthKey] || 0;
      
      if(meta === 0) return { status: 'nodata', meta: 0, real: 0, pct: 0, proj: 0, needed: 0, expected: 0, gap: 0 };

      const pct = real / meta;
      const expected = meta * wd.progress;
      const proj = wd.elapsed > 0 ? (real / wd.elapsed) * wd.total : 0;
      const gap = Math.max(meta - proj, 0); // Gap = (meta do m√™s) ‚àí (proje√ß√£o do m√™s), nunca negativo
      const needed = wd.remaining > 0 ? (meta - real) / wd.remaining : 0;
      
      let status = 'neutral';
      if(real >= expected) status = 'good';
      else if(real >= expected * 0.95) status = 'warning'; // 5% toler√¢ncia
      else status = 'bad';

      if(pct >= 1) status = 'won'; // Meta batida

      return { meta, real, pct, proj, needed, status, expected, gap };
    }

    /* --- 3. UI RENDER --- */
    const formatMoney = v => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
    const formatNum = v => Math.round(v).toLocaleString('pt-BR');
    const formatPct = v => (v*100).toFixed(1) + '%';

    const formatMoneyCompact = v => formatMoney(v).replace(/^R\$\s+/, 'R$');


    function render() {
      // 1. Setup Data
      const [yStr, mStr] = state.month.split('-');
      const wd = getWorkdays(parseInt(yStr), parseInt(mStr));
      
      // 2. Hero Section (Faturamento Total)
      const fat = calculateKPI('faturamento', state.month, wd);


      // Estilo do card (igual aos KPIs abaixo)
      const heroBorder =
        (fat.status === 'won') ? "border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.2)]" :
        (fat.status === 'good') ? "border-emerald-500/50" :
        (fat.status === 'warning') ? "border-jeep/50" :
        (fat.status === 'bad') ? "border-ram/50" :
        "border-white/5";

      const heroBar =
        (fat.status === 'won' || fat.status === 'good') ? "bg-emerald-500" :
        (fat.status === 'warning') ? "bg-jeep" :
        (fat.status === 'bad') ? "bg-red-500" :
        "bg-slate-600";

      const heroCardEl = document.getElementById('fatHeroCard');
      if (heroCardEl) {
        heroCardEl.className = `glass-card rounded-3xl p-6 md:p-8 relative overflow-hidden border ${heroBorder}`;
      }


      // Hint de tempo (dias √∫teis)
      document.getElementById('fatTimeHint').textContent =
        `${wd.elapsed}/${wd.total} dias √∫teis ‚Ä¢ restam ${wd.remaining} ‚Ä¢ ${formatPct(wd.progress)} do m√™s`;

      // Valores (hero)
      document.getElementById('fatRealBig').textContent = formatMoney(fat.real);
      document.getElementById('fatMetaBig').textContent = formatMoney(fat.meta);
      document.getElementById('fatPctBig').textContent = formatPct(fat.pct);

      document.getElementById('fatExpectedBig').textContent = formatMoneyCompact(fat.expected);
      document.getElementById('fatProjBig').textContent = formatMoneyCompact(fat.proj);
      document.getElementById('fatGapBig').textContent = formatMoneyCompact(fat.gap);
      document.getElementById('fatNeededBig').textContent = formatMoneyCompact(fat.needed);

      // Barra de progresso (realizado) + marcador (ritmo ideal por dias √∫teis)
      const fatFill = document.getElementById('fatBarFill');
      if (fatFill) {
        fatFill.className = `h-full ${heroBar} transition-all duration-700 ease-out`;
        fatFill.style.width = `${Math.min(100, fat.pct * 100)}%`;
      }
      document.getElementById('fatIdealMarker').style.left = `${wd.progress * 100}%`;

      // Cor din√¢mica do Gap / Necess√°rio
      const gapEl = document.getElementById('fatGapBig');
      gapEl.className = `min-w-0 max-w-full tabular-nums whitespace-nowrap tracking-tight text-[clamp(1.05rem,2.0vw,1.35rem)] md:text-[clamp(1.10rem,1.6vw,1.40rem)] lg:text-[1.28rem] xl:text-[1.32rem] leading-none font-display font-black ${fat.gap > 0 ? 'text-ram' : 'text-emerald-400'}`;

      const needEl = document.getElementById('fatNeededBig');
      needEl.className = `min-w-0 max-w-full tabular-nums whitespace-nowrap tracking-tight text-[clamp(1.05rem,2.0vw,1.35rem)] md:text-[clamp(1.10rem,1.6vw,1.40rem)] lg:text-[1.28rem] xl:text-[1.32rem] leading-none font-display font-black ${fat.needed > 0 ? 'text-jeep' : 'text-slate-500'}`;

      // Badge do HERO (status do faturamento)
      const fatBadge = document.getElementById('fatStatusBadge');
      if (fat.status === 'nodata') {
        fatBadge.textContent = "SEM META";
        fatBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-300";
      } else if (fat.status === 'won') {
        fatBadge.textContent = "META BATIDA";
        fatBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-emerald-500 text-black";
      } else if (fat.status === 'good') {
        fatBadge.textContent = "NO EIXO";
        fatBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";
      } else if (fat.status === 'warning') {
        fatBadge.textContent = "ATEN√á√ÉO";
        fatBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-jeep/20 text-jeep border border-jeep/30";
      } else {
        fatBadge.textContent = "CR√çTICO";
        fatBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-ram/20 text-ram border border-ram/30";
      }

      // Badge de Ritmo Global (m√©dia simples dos 3 KPIs operacionais)
      let score = 0;
      KPIS_ALL.forEach(k => {
        const res = calculateKPI(k.id, state.month, wd);
        if (res.status === 'won' || res.status === 'good') score++;
      });

      let paceText = "CR√çTICO";
      let paceCls = "bg-ram/20 text-ram border border-ram/30";
      if (score === 3) { paceText = "EXCELENTE"; paceCls = "bg-emerald-500/20 text-emerald-300 border border-emerald-500/30"; }
      else if (score >= 1) { paceText = "MISTO"; paceCls = "bg-jeep/20 text-jeep border border-jeep/30"; }

      const paceInfo = { text: paceText, cls: paceCls, workdays: wd };


      // 3. KPI Cards
      const cardsContainer = document.getElementById('kpiCards');
      cardsContainer.innerHTML = '';
      
      KPIS_DASH.forEach(def => {
        // Card especial: Ritmo do M√™s (dias √∫teis) ‚Äî vers√£o compacta
        if (def.type === 'pace') {
          const w = paceInfo.workdays;
          const card = document.createElement('div');
          const paceBorder = (paceInfo.text === 'EXCELENTE') ? 'border-emerald-500/50' : (paceInfo.text === 'MISTO') ? 'border-jeep/50' : 'border-ram/50';
          const paceBar = (paceInfo.text === 'EXCELENTE') ? 'bg-emerald-500' : (paceInfo.text === 'MISTO') ? 'bg-jeep' : 'bg-red-500';
          card.className = `glass-card rounded-2xl p-5 border ${paceBorder} relative overflow-hidden group`;
          card.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-dark-900 flex items-center justify-center text-xl text-slate-400 group-hover:text-white transition-colors">
                  <i class="fa-solid ${def.icon}"></i>
                </div>
                <div>
                  <h3 class="text-xs font-bold uppercase text-slate-500 tracking-wider">${def.label}</h3>
                  <div class="text-[10px] text-slate-600">${w.elapsed}/${w.total} dias √∫teis ‚Ä¢ restam ${w.remaining}</div>
                </div>
              </div>
              <div class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${paceInfo.cls}">${paceInfo.text}</div>
            </div>

            <div class="flex items-baseline gap-2 mb-2">
              <span class="text-2xl font-display font-black text-white">${formatPct(w.progress)}</span>
              <span class="text-xs text-slate-500 font-bold">do m√™s (dias √∫teis)</span>
            </div>

            <div class="h-1.5 w-full bg-dark-950 rounded-full mb-3 relative overflow-hidden">
              <div class="absolute h-full ${paceBar}" style="width: ${Math.min(100, w.progress*100)}%"></div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-xs border-t border-white/5 pt-3">
              <div>
                <span class="block text-[10px] text-slate-600 uppercase">Dias √∫teis total</span>
                <span class="font-bold text-slate-300">${w.total}</span>
              </div>
              <div class="text-right">
                <span class="block text-[10px] text-slate-600 uppercase">Dias √∫teis decorridos</span>
                <span class="font-bold text-slate-300">${w.elapsed}</span>
              </div>
            </div>

            <p class="mt-3 text-[10px] text-slate-600 flex items-center gap-1">
              <i class="fa-solid fa-calendar-check text-jeep"></i> ${w.total} dias √∫teis considerados.
            </p>
          `;
          cardsContainer.appendChild(card);
          return;
        }

        const data = calculateKPI(def.id, state.month, wd);
        const isMoney = def.type === 'money';
        const valFmt = isMoney ? formatMoney : formatNum;
        
        let colorClass = "border-white/5";
        let textClass = "text-slate-400";
        let statusIcon = "";
        let barColor = "bg-slate-600";
        
        if(data.status === 'won') { colorClass = "border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.2)]"; textClass = "text-emerald-400"; barColor="bg-emerald-500"; statusIcon="üèÜ"; }
        else if(data.status === 'good') { colorClass = "border-emerald-500/50"; textClass = "text-emerald-500"; barColor="bg-emerald-500"; statusIcon="OK"; }
        else if(data.status === 'warning') { colorClass = "border-jeep/50"; textClass = "text-jeep"; barColor="bg-jeep"; statusIcon="‚ö†Ô∏è"; }
        else if(data.status === 'bad') { colorClass = "border-ram/50"; textClass = "text-red-500"; barColor="bg-red-500"; statusIcon="üîª"; }

        const card = document.createElement('div');
        card.className = `glass-card rounded-2xl p-5 border ${colorClass} relative overflow-hidden group`;
        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-dark-900 flex items-center justify-center text-xl text-slate-400 group-hover:text-white transition-colors">
                <i class="fa-solid ${def.icon}"></i>
              </div>
              <div>
                <h3 class="text-xs font-bold uppercase text-slate-500 tracking-wider">${def.label}</h3>
                <div class="text-[10px] text-slate-600">Meta: ${valFmt(data.meta)}</div>
              </div>
            </div>
            <div class="font-black text-lg ${textClass}">${statusIcon}</div>
          </div>
          
          <div class="flex items-baseline gap-1 mb-2">
            <span class="text-2xl font-display font-black text-white">${valFmt(data.real)}</span>
            <span class="text-xs text-slate-500 font-bold">(${formatPct(data.pct)})</span>
          </div>

          <div class="h-1.5 w-full bg-dark-950 rounded-full mb-3 relative overflow-hidden">
            <div class="absolute h-full ${barColor}" style="width: ${Math.min(100, data.pct*100)}%"></div>
            <div class="absolute h-full w-0.5 bg-white shadow-[0_0_5px_white]" style="left: ${wd.progress*100}%" title="Ritmo Ideal (meta proporcional aos dias √∫teis)"></div>
          </div>

          <div class="flex items-center justify-between text-xs mb-3">
            <div>
              <span class="block text-[10px] text-slate-600 uppercase">Ritmo ideal hoje</span>
              <span class="font-bold text-slate-300">${valFmt(data.expected)}</span>
            </div>
            <div class="text-right">
              <span class="block text-[10px] text-slate-600 uppercase">Gap (meta‚àíproj)</span>
              <span class="font-bold ${data.gap > 0 ? 'text-ram' : 'text-emerald-400'}" title="Gap = (meta do m√™s) ‚àí (proje√ß√£o do m√™s). Se a proje√ß√£o estiver acima da meta, o gap fica 0.">${valFmt(data.gap)}</span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 text-xs border-t border-white/5 pt-3">
            <div>
              <span class="block text-[10px] text-slate-600 uppercase">Proje√ß√£o</span>
              <span class="font-bold text-slate-300">${valFmt(data.proj)}</span>
            </div>
            <div class="text-right">
              <span class="block text-[10px] text-slate-600 uppercase">Necess√°rio/Dia</span>
              <span class="font-bold ${data.needed > 0 ? 'text-jeep' : 'text-slate-500'}">${valFmt(data.needed)}</span>
            </div>
          </div>
        `;
        cardsContainer.appendChild(card);
      });

      // 4. Data Table (Inputs)
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = '';
      KPIS_ALL.forEach(def => {
        const metaVal = state.data.metas[def.id][state.month] || 0;
        const realVal = state.data.realizado[def.id][state.month] || 0;
        
        const tr = document.createElement('tr');
        tr.className = "hover:bg-white/5 transition-colors";
        tr.innerHTML = `
          <td class="px-6 py-3 font-bold text-slate-300 flex items-center gap-2">
            <i class="fa-solid ${def.icon} text-slate-600"></i> ${def.label}
          </td>
          <td class="px-6 py-3">
             <input type="number" step="0.01" class="bg-dark-950 border border-white/10 rounded px-2 py-1 text-white w-32 focus:border-jeep outline-none" 
              value="${metaVal}" onchange="updateData('metas', '${def.id}', this.value)">
          </td>
          <td class="px-6 py-3">
             <input type="number" step="0.01" class="bg-dark-950 border border-white/10 rounded px-2 py-1 text-white w-32 focus:border-jeep outline-none font-bold" 
              value="${realVal}" onchange="updateData('realizado', '${def.id}', this.value)">
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 5. Configs
      document.getElementById('toggleSat').checked = state.config.sat;
      document.getElementById('toggleOptional').checked = state.config.optional;
      renderHolidays();
    }

    function renderHolidays() {
      const list = document.getElementById('holidayList');
      list.innerHTML = '';
      state.config.holidays.forEach((h, idx) => {
        const div = document.createElement('div');
        div.className = "flex justify-between items-center bg-dark-900 px-3 py-2 rounded border border-white/5";
        div.innerHTML = `<span>${h}</span> <button onclick="removeHoliday(${idx})" class="text-ram"><i class="fa-solid fa-trash"></i></button>`;
        list.appendChild(div);
      });
    }

    /* --- 4. A√á√ïES & EVENTOS --- */
    
    // Atualiza dados na mem√≥ria (n√£o salva no localstorage ainda, s√≥ ao clicar salvar)
    window.updateData = (type, kpi, val) => {
      state.data[type][kpi][state.month] = parseFloat(val) || 0;
    };

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      showToast();
      render();
      updateTimeDisplay();
    }

    function loadFromStorage() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if(stored) {
        try {
          const parsed = JSON.parse(stored);
          // Merge para garantir estrutura
          state = { ...state, ...parsed }; 
        } catch(e) { console.error("Erro ao carregar dados", e); }
      }
      // Populate month select
      const sel = document.getElementById('monthSelect');
      sel.innerHTML = '';
      MONTHS.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.label;
        if(m.id === state.month) opt.selected = true;
        opt.className = "text-black";
        sel.appendChild(opt);
      });
      render();
    }

    function updateTimeDisplay() {
      const iso = state && state.__cloud && state.__cloud.savedAt ? state.__cloud.savedAt : null;
      const dt = iso ? new Date(iso) : new Date();
      const hhmm = dt.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
      document.getElementById('lastUpdateText').textContent = "Atualizado: " + hhmm + (iso ? " (nuvem)" : "");
    }

    function showToast(msg = "Dados Salvos!") {
      const t = document.getElementById('toast');
      document.getElementById('toastMsg').textContent = msg;
      t.classList.remove('translate-y-20', 'opacity-0');
      setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 2500);
    }

    // Gerenciador de Abas
    document.addEventListener('click', (e) => {
      // 1. Abas
      const tabBtn = e.target.closest('[data-action="tab"]');
      if(tabBtn) {
        // UI
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-white/5', 'text-white'));
        document.querySelectorAll('.nav-btn i').forEach(i => i.classList.remove('text-jeep'));
        
        tabBtn.classList.add('active', 'bg-white/5', 'text-white');
        tabBtn.querySelector('i').classList.add('text-jeep');

        // Content
        const targetId = tabBtn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${targetId}`).classList.remove('hidden');
      }

      // 2. Salvar Geral
      if(e.target.closest('[data-action="save-all"]')) {
        saveToStorage();
      }

      // 3. Adicionar Feriado
      if(e.target.closest('[data-action="add-holiday"]')) {
        const inp = document.getElementById('holidayInput');
        if(inp.value) {
          state.config.holidays.push(inp.value);
          inp.value = '';
          saveToStorage();
        }
      }

      // 4. Export JSON
      if(e.target.closest('[data-action="export-json"]')) {
        const blob = new Blob([JSON.stringify(state, null, 2)], {type : 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_dva_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
      }
    });

    // Import JSON
    document.getElementById('importFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          state = JSON.parse(ev.target.result);
          saveToStorage();
          showToast("Backup Restaurado!");
        } catch(err) { alert("Arquivo inv√°lido"); }
      };
      reader.readAsText(file);
    });

    // Import Planilha (ODS/XLSX/CSV) ‚Äî suporta:
    // (A) Formato "blocos" (igual METAS 2026.ods): KPI na 1¬™ coluna, meses no cabe√ßalho da linha, meta na linha abaixo e "ATINGIDO..." na pr√≥xima
    // (B) Formato "tabela": colunas KPI | Meta | Realizado | (opcional) M√™s
    document.getElementById('sheetFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;

      const ext = (file.name.split('.').pop() || '').toLowerCase();

      try {
        let wb;
        if(ext === 'csv') {
          const text = await file.text();
          wb = XLSX.read(text, { type: 'string' });
        } else {
          const buf = await file.arrayBuffer();
          wb = XLSX.read(buf, { type: 'array' });
        }

        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        const norm = (s) => String(s || "")
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
          .toLowerCase().trim();

        const toNumber = (v) => {
          if(v === null || v === undefined) return NaN;
          if(typeof v === 'number') return v;
          let s = String(v).trim();
          if(!s) return NaN;
          s = s.replace(/\s/g,'').replace(/[R$\u00A0]/g,'');
          // pt-BR: 1.234,56 -> 1234.56
          if(/,\d{1,}$/.test(s)) s = s.replace(/\./g,'').replace(/,/g,'.');
          const n = Number(s);
          return Number.isFinite(n) ? n : NaN;
        };

        const kpiIdFromText = (v) => {
          const s = norm(v);
          if(s.includes('fatur')) return 'faturamento';
          if(s.includes('pass')) return 'passagens';
          if(s.includes('mao') || s.includes('m√£o') || s.includes('oficina')) return 'mao_obra';
          return null;
        };

        const MONTH_MAP = {
          'janeiro':'01','jan':'01',
          'fevereiro':'02','fev':'02',
          'marco':'03','mar':'03', 'mar√ßo':'03',
          'abril':'04','abr':'04',
          'maio':'05','mai':'05',
          'junho':'06','jun':'06',
          'julho':'07','jul':'07',
          'agosto':'08','ago':'08',
          'setembro':'09','set':'09','sep':'09',
          'outubro':'10','out':'10','oct':'10',
          'novembro':'11','nov':'11',
          'dezembro':'12','dez':'12','dec':'12'
        };

        const detectYearFromSheet = (aoa) => {
          for(const row of aoa){
            for(const cell of row){
              if(typeof cell !== 'string') continue;
              const m = cell.match(/(20\d{2})/);
              if(m) return m[1];
            }
          }
          return null;
        };

        const monthKeyFromHeader = (year, v) => {
          const s = norm(v);
          if(!s) return null;
          // suporta "2026-02" / "2026/2"
          const m = s.match(/(20\d{2})[-\/](\d{1,2})/);
          if(m) return `${m[1]}-${String(m[2]).padStart(2,'0')}`;
          // suporta "Fevereiro 2026" (labels do app)
          const byLabel = MONTHS.find(x => norm(x.label) === s);
          if(byLabel) return byLabel.id;
          // suporta m√™s por extenso/abrevia√ß√£o
          const mm = MONTH_MAP[s];
          if(mm) return `${year}-${mm}`;
          return null;
        };

        // -----------------------
        // 1) Tenta "formato blocos" (igual METAS 2026.ods)
        // -----------------------
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: true });
        const year = detectYearFromSheet(aoa) || String(state.month).slice(0,4) || "2026";

        let changed = 0;
        let blocksFound = 0;

        for(let r=0; r<aoa.length; r++){
          const row = aoa[r] || [];
          const id = kpiIdFromText(row[0]);
          if(!id) continue;

          // Conta quantos "meses" existem na linha (colunas 1+)
          let monthCols = [];
          for(let c=1; c<row.length; c++){
            const mk = monthKeyFromHeader(year, row[c]);
            if(mk) monthCols.push({ c, mk });
          }

          // Para evitar falsos positivos: exige pelo menos 4 meses identificados na mesma linha
          if(monthCols.length < 4) continue;

          blocksFound++;

          // Garante estrutura
          state.data.metas[id] = state.data.metas[id] || {};
          state.data.realizado[id] = state.data.realizado[id] || {};

          const metaRow = aoa[r+1] || [];
          const realRow = aoa[r+2] || [];
          const hasAtingidoRow = norm(realRow[0]).includes('atingido');

          for(const {c, mk} of monthCols){
            const mv = toNumber(metaRow[c]);
            if(Number.isFinite(mv)){
              state.data.metas[id][mk] = mv;
              changed++;
            }
            if(hasAtingidoRow){
              const rv = toNumber(realRow[c]);
              if(Number.isFinite(rv)){
                state.data.realizado[id][mk] = rv;
                changed++;
              }
            }
          }

          // pula para frente para n√£o reprocessar linhas internas do mesmo bloco
          r = r + 2;
        }

        // -----------------------
        // 2) Se n√£o achou blocos, tenta "formato tabela" (KPI/Meta/Realizado/M√™s)
        // -----------------------
        if(blocksFound === 0){
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: true });
          if(!rows.length) { alert("Planilha vazia."); return; }

          const pickCol = (rowKeys, needles) => {
            for(const k of rowKeys) {
              const nk = norm(k);
              if(needles.some(n => nk.includes(n))) return k;
            }
            return null;
          };

          const parseMonthCell = (v) => monthKeyFromHeader(year, v);

          const keys = Object.keys(rows[0] || {});
          const colKPI  = pickCol(keys, ['kpi','indic','indicador','nome']);
          const colMeta = pickCol(keys, ['meta','objetiv','target']);
          const colReal = pickCol(keys, ['real','ating','acumul','feito','produz']);
          const colMes  = pickCol(keys, ['mes','month','compet']);

          if(!colKPI || (!colMeta && !colReal)) {
            alert(
              "N√£o consegui identificar as colunas.\n\n" +
              "Aceitos:\n" +
              "‚Ä¢ Formato BLOCO (igual METAS 2026.ods): KPI + meses na linha, meta abaixo e (opcional) 'ATINGIDO...' abaixo.\n" +
              "‚Ä¢ Formato TABELA: KPI | Meta | Realizado | (opcional) M√™s\n\n" +
              "Se quiser, me mande um print da 1¬™ aba que eu adapto 100%."
            );
            return;
          }

          rows.forEach(r => {
            const id = kpiIdFromText(r[colKPI]);
            if(!id) return;

            state.data.metas[id] = state.data.metas[id] || {};
            state.data.realizado[id] = state.data.realizado[id] || {};

            const monthKey = colMes ? (parseMonthCell(r[colMes]) || state.month) : state.month;

            if(colMeta) {
              const mv = toNumber(r[colMeta]);
              if(Number.isFinite(mv)) {
                state.data.metas[id][monthKey] = mv;
                changed++;
              }
            }
            if(colReal) {
              const rv = toNumber(r[colReal]);
              if(Number.isFinite(rv)) {
                state.data.realizado[id][monthKey] = rv;
                changed++;
              }
            }
          });
        }

        saveToStorage();
        render();
        showToast(changed ? "Planilha importada!" : "Planilha lida, mas nenhum campo foi aplicado.");
        // Persist√™ncia entre PCs: salva latest.xlsx + estado no Supabase
        sbSyncAfterUpload(wb);
} catch(err) {
        console.error(err);
        alert("Falha ao ler a planilha.\n\nDicas:\n‚Ä¢ Confirme que √© .ods/.xlsx/.xls/.csv\n‚Ä¢ Para METAS 2026.ods, mantenha o layout por blocos\n‚Ä¢ Se a 1¬™ aba tiver v√°rios quadros, deixe o quadro principal (Faturamento/Passagens/M√£o de Obra) no topo");
      } finally {
        e.target.value = "";
      }
    });


    // Remover Feriado
    window.removeHoliday = (idx) => {
      state.config.holidays.splice(idx, 1);
      saveToStorage();
    };

    // Mudar M√™s
    document.getElementById('monthSelect').addEventListener('change', (e) => {
      state.month = e.target.value;
      document.getElementById('mobileMonthDisplay').textContent = e.target.options[e.target.selectedIndex].text;
      render();
    });

    // Config Toggles
    document.getElementById('toggleSat').addEventListener('change', e => { state.config.sat = e.target.checked; saveToStorage(); });
    document.getElementById('toggleOptional').addEventListener('change', e => { state.config.optional = e.target.checked; saveToStorage(); });

    // INIT
    window.addEventListener('DOMContentLoaded', async () => {
      loadFromStorage();
      // Set Active Tab Initial
      document.querySelector('[data-tab="dashboard"]').click();
      updateTimeDisplay();

      // Cloud sync (se existir estado remoto, substitui o local)
      await sbTryLoadRemoteState();
    });

  </script>

  <script>
    // ------------------------------
    // Campanhas Q1 2026 (namespace)
    // ------------------------------
    (() => {
      const CAMP = {
        q: { start: "01/01/2026", end: "31/03/2026" },
        sectors: [
          {
            id: "assistentes",
            name: "Assistentes de P√≥s-Venda",
            subtitle: "Campanha NPS Jeep ‚Äî Q1 2026 (fechamento trimestral)",
            badges: ["Trimestral", "NPS Jeep", "Coletivo (AOP)"],
            kpis: [
              { label: "Meta NPS Jeep", value: "‚â• 89%", note: "Faixa 1 ‚Äî fechamento do Q1" },
              { label: "Pr√™mio", value: "R$ 450", note: "Trimestral" },
              { label: "Pagamento", value: "Folha", note: "04/2026" }
            ],
            rules: [
              { t: "Gatilho", d: "Atingir ou superar NPS Jeep ‚â• 89% no fechamento do Q1 (JAN/FEV/MAR)." },
              { t: "Corte (AOP)", d: "Se a AOP/√°rea operacional da filial n√£o fechar ‚â• 89%, n√£o h√° pagamento." },
              { t: "Corte (base)", d: "Qualidade da base deve ser ‚â• 80%. Abaixo disso, n√£o paga." },
              { t: "Regra coletiva", d: "Se uma filial bater, mas a m√©dia das demais filiais da mesma AOP n√£o bater, nenhuma recebe." }
            ],
            premios: [
              { title: "Trimestral (Q1)", value: "R$ 450,00", detail: "Assistentes ‚Äî se condi√ß√µes atendidas" }
            ],
            timeline: [
              { when: "Fechamento Q1", what: "Apura√ß√£o NPS Jeep (JAN+FEV+MAR)", how: "Montadora / consolida√ß√£o do quarter" },
              { when: "04/2026", what: "Pagamento", how: "Folha de pagamento" }
            ],
            extras: [
              "Garantir cadastros corretos (email/telefone) para proteger qualidade da base.",
              "Monitorar detratores em tempo real e sinalizar casos cr√≠ticos ao gerente.",
              "Padronizar confirma√ß√£o de dados no check-in e na entrega."
            ]
          },

          {
            id: "consultores",
            name: "Consultores de P√≥s-Venda",
            subtitle: "Premia√ß√£o mensal por marca + b√¥nus de fechamento do Q1 (unidade) ‚Äî Jeep & Ram",
            badges: ["Mensal", "Trimestral", "Jeep & Ram", "BEE / Cart√£o"],
            kpis: [
              { label: "Meta Jeep", value: "‚â• 89%", note: "Faixa 1 (mensal e Q1)" },
              { label: "Meta Ram", value: "‚â• 86%", note: "Faixa 1 (mensal e Q1)" },
              { label: "M√≠n. de pesquisas", value: "Jeep 20 ‚Ä¢ Ram 4", note: "por consultor / m√™s" }
            ],
            rules: [
              { t: "Mensal (Jeep)", d: "NPS Jeep individual ‚â• 89% + m√≠nimo 20 pesquisas respondidas no m√™s." },
              { t: "Mensal (Ram)", d: "NPS Ram individual ‚â• 86% + m√≠nimo 4 pesquisas respondidas no m√™s." },
              { t: "B√¥nus Q1 (unidade)", d: "Unidade bate a meta trimestral: Jeep ‚â• 89% e/ou Ram ‚â• 86% (por marca)." },
              { t: "Corte (base)", d: "Qualidade da base deve ser ‚â• 80% para liberar b√¥nus trimestral." },
              { t: "Elegibilidade", d: "Contratados durante o quarter n√£o recebem valores trimestrais." }
            ],
            premios: [
              { title: "Mensal ‚Äî Jeep", value: "R$ 350,00", detail: "Pagto via BEE at√© dia 10 do m√™s seguinte" },
              { title: "Mensal ‚Äî Ram", value: "R$ 300,00", detail: "Pagto via BEE at√© dia 10 do m√™s seguinte" },
              { title: "B√¥nus Q1 (unidade) ‚Äî Jeep", value: "R$ 1.000,00", detail: "Pagamento em 10/05/2026" },
              { title: "B√¥nus Q1 (unidade) ‚Äî Ram", value: "R$ 800,00", detail: "Pagamento em 10/05/2026" }
            ],
            timeline: [
              { when: "10/02/2026", what: "Pagamento JAN", how: "Cart√£o BEE" },
              { when: "10/03/2026", what: "Pagamento FEV", how: "Cart√£o BEE" },
              { when: "10/04/2026", what: "Pagamento MAR", how: "Cart√£o BEE" },
              { when: "10/05/2026", what: "B√¥nus fechamento Q1", how: "Por marca (Jeep/Ram) ‚Äî unidade" }
            ],
            extras: [
              "Priorizar follow-up de clientes neutros/detratores ainda dentro da janela da pesquisa.",
              "Atentar ao volume m√≠nimo de pesquisas: sem volume, n√£o h√° premia√ß√£o mesmo com NPS alto.",
              "Evitar erros de cadastro (email/telefone) ‚Äî impacto direto na qualidade da base."
            ]
          },

          {
            id: "gerentes",
            name: "Gerentes de P√≥s-Venda",
            subtitle: "Campanha ‚ÄúAcelerando Resultados‚Äù ‚Äî 3 indicadores (passagens, faturamento, NPS)",
            badges: ["Mensal", "Trimestral", "Opera√ß√£o & Qualidade", "Cart√£o premia√ß√£o"],
            kpis: [
              { label: "Passagens (OS)", value: "+20% YoY", note: "m√≠n. 200 ve√≠culos (exceto Brusque)" },
              { label: "Faturamento PV", value: "+20% YoY", note: "deduzindo CITs internos" },
              { label: "NPS", value: "Jeep ‚â• 89% ‚Ä¢ Ram ‚â• 86%", note: "mensal + Q1 (AOP)" }
            ],
            rules: [
              { t: "Indicador 1", d: "Passagens: >20% vs mesmo m√™s do ano anterior; m√≠nimo 200 ve√≠culos (exce√ß√£o: Brusque); filtrando CITs." },
              { t: "Indicador 2", d: "Faturamento total do p√≥s-venda: +20% vs ano anterior (deduzindo CITs internos)." },
              { t: "Indicador 3 (mensal)", d: "NPS mensal: pagamento se bater NPS Jeep e Ram nas metas da montadora." },
              { t: "Indicador 3 (trimestral)", d: "NPS trimestral (AOP): se fechar Jeep 89% e Ram 86% (ambas acima do preconizado)." },
              { t: "B√¥nus adicional", d: "Se entregar os 3 indicadores no m√™s, paga ‚ÄúSupera√ß√£o M√°xima‚Äù e encerra as demais campanhas vigentes no m√™s." }
            ],
            premios: [
              { title: "Passagens (100%)", value: "R$ 600,00", detail: "Mensal" },
              { title: "Faturamento (100%)", value: "R$ 400,00", detail: "Mensal" },
              { title: "NPS (mensal)", value: "R$ 1.000,00", detail: "Mensal ‚Äî Jeep + Ram" },
              { title: "NPS (Q1 / AOP)", value: "R$ 2.500,00", detail: "Trimestral ‚Äî pagamento em 10/06/2026" },
              { title: "Supera√ß√£o M√°xima", value: "R$ 2.000,00", detail: "Mensal ‚Äî se os 3 indicadores baterem" }
            ],
            timeline: [
              { when: "10/02/2026", what: "Mensal (JAN)", how: "Cart√£o premia√ß√£o" },
              { when: "10/03/2026", what: "Mensal (FEV)", how: "Cart√£o premia√ß√£o" },
              { when: "10/04/2026", what: "Mensal (MAR)", how: "Cart√£o premia√ß√£o" },
              { when: "10/06/2026", what: "NPS Q1 (AOP)", how: "Cart√£o premia√ß√£o" }
            ],
            extras: [
              "Tratar CITs conforme regra (filtragem/dedu√ß√£o em passagens e faturamento).",
              "Manter governan√ßa de NPS (casos cr√≠ticos + plano de a√ß√£o).",
              "Foco simult√¢neo: volume (passagens) + receita + qualidade (NPS)."
            ]
          },

          {
            id: "oficina",
            name: "Chefia de Oficina & Produtivos ‚Äî Balne√°rio",
            subtitle: "Meta de faturamento de m√£o de obra por m√™s (exclui servi√ßos internos e funilaria)",
            badges: ["Mensal", "M√£o de obra", "Folha", "Balne√°rio"],
            kpis: [
              { label: "Meta Jan/2026", value: "R$ 199.114", note: "M√£o de obra" },
              { label: "Meta Fev/2026", value: "R$ 199.069", note: "M√£o de obra" },
              { label: "Meta Mar/2026", value: "R$ 169.867", note: "M√£o de obra" }
            ],
            rules: [
              { t: "Gatilho", d: "Premia√ß√£o somente se atingir 100% da meta mensal de m√£o de obra." },
              { t: "Escopo", d: "N√£o entra: m√£o de obra de servi√ßos internos e funilaria." },
              { t: "Produtivos", d: "Produtivo recebe se trabalhou e apontou servi√ßos no m√™s." }
            ],
            premios: [
              { title: "Jan/Fev ‚Äî Chefe", value: "R$ 800,00", detail: "Se 100% da meta mensal" },
              { title: "Jan/Fev ‚Äî Cada produtivo", value: "R$ 400,00", detail: "Se trabalhou e apontou" },
              { title: "Mar ‚Äî Chefe", value: "R$ 600,00", detail: "Se 100% da meta mensal" },
              { title: "Mar ‚Äî Cada produtivo", value: "R$ 300,00", detail: "Se trabalhou e apontou" }
            ],
            timeline: [
              { when: "02/2026", what: "Pagamento Jan", how: "Folha (m√™s seguinte)" },
              { when: "03/2026", what: "Pagamento Fev", how: "Folha (m√™s seguinte)" },
              { when: "04/2026", what: "Pagamento Mar", how: "Folha (m√™s seguinte)" }
            ],
            extras: [
              "Garantir apontamento consistente: sem apontamento, pode perder elegibilidade.",
              "Separar corretamente o que √© interno/funilaria para n√£o distorcer apura√ß√£o.",
              "Rotina di√°ria de controle de MO realizada vs meta mensal."
            ]
          },

          {
            id: "produtivos_nps",
            name: "Produtivos de P√≥s-Venda (Mec√¢nicos) ‚Äî NPS",
            subtitle: "Campanha NPS Jeep ‚Äî Q1 2026 (modelo igual ao de Assistentes)",
            badges: ["Trimestral", "NPS Jeep", "Coletivo (AOP)"],
            kpis: [
              { label: "Meta NPS Jeep", value: "‚â• 89%", note: "Faixa 1 ‚Äî fechamento do Q1" },
              { label: "Pr√™mio", value: "R$ 450", note: "Trimestral" },
              { label: "Pagamento", value: "Folha", note: "04/2026" }
            ],
            rules: [
              { t: "Gatilho", d: "Atingir ou superar NPS Jeep ‚â• 89% no fechamento do Q1 (JAN/FEV/MAR)." },
              { t: "Corte (AOP)", d: "Se a AOP/√°rea operacional da filial n√£o fechar ‚â• 89%, n√£o h√° pagamento." },
              { t: "Corte (base)", d: "Qualidade da base deve ser ‚â• 80%. Abaixo disso, n√£o paga." },
              { t: "Regra coletiva", d: "Se uma filial bater, mas a m√©dia das demais filiais da mesma AOP n√£o bater, nenhuma recebe." }
            ],
            premios: [
              { title: "Trimestral (Q1)", value: "R$ 450,00", detail: "Produtivos/mec√¢nicos ‚Äî se condi√ß√µes atendidas" }
            ],
            timeline: [
              { when: "Fechamento Q1", what: "Apura√ß√£o NPS Jeep (JAN+FEV+MAR)", how: "Montadora / consolida√ß√£o do quarter" },
              { when: "04/2026", what: "Pagamento", how: "Folha de pagamento" }
            ],
            extras: [
              "Qualidade percebida no p√≥s-servi√ßo impacta diretamente NPS (execu√ß√£o, entrega, retorno).",
              "Evitar retrabalho: falha t√©cnica costuma virar detrator com facilidade.",
              "Checar padr√£o de limpeza/organiza√ß√£o do ve√≠culo antes da entrega."
            ]
          }
        ]
      };

      const KEY_MODE = "dva_campanhas_mode";
      const KEY_ACTIVE = "dva_campanhas_active";

      const $ = (id) => document.getElementById(id);

      const state = {
        mode: (localStorage.getItem(KEY_MODE) || "detalhado") === "compacto" ? "compacto" : "detalhado",
        activeId: localStorage.getItem(KEY_ACTIVE) || (CAMP.sectors[0] && CAMP.sectors[0].id),
        search: ""
      };

      const escapeHtml = (s) => (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");

      const badge = (t) =>
        `<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-wider bg-white/5 border border-white/10 text-slate-200">${escapeHtml(t)}</span>`;

      const icon = (id) => {
        const m = {
          assistentes: "fa-user-check",
          consultores: "fa-comments",
          gerentes: "fa-chart-line",
          oficina: "fa-wrench",
          produtivos_nps: "fa-star"
        };
        return m[id] || "fa-circle";
      };

      const toast = (msg) => {
        if (typeof window.showToast === "function") return window.showToast(msg);
        try { console.log(msg); } catch {}
      };

      const applySearch = (text) => {
        const q = (state.search || "").trim().toLowerCase();
        if (!q) return true;
        return (text || "").toLowerCase().includes(q);
      };

      const sectorText = (sec) => {
        const parts = [];
        parts.push(sec.name, sec.subtitle);
        (sec.badges||[]).forEach(b => parts.push(b));
        (sec.kpis||[]).forEach(k => parts.push(k.label, k.value, k.note||""));
        (sec.rules||[]).forEach(r => parts.push(r.t, r.d));
        (sec.premios||[]).forEach(p => parts.push(p.title, p.value, p.detail||""));
        (sec.timeline||[]).forEach(t => parts.push(t.when, t.what, t.how||""));
        (sec.extras||[]).forEach(e => parts.push(e));
        return parts.join(" ‚Ä¢ ");
      };

      const navButton = (sec, active, mobile=false) => {
        const base = mobile
          ? "shrink-0 px-3 py-2 rounded-2xl text-xs font-black uppercase tracking-wider border transition flex items-center gap-2"
          : "w-full p-3 rounded-2xl border border-white/10 hover:border-white/20 bg-dark-950 hover:bg-white/5 transition flex items-center justify-between gap-3";
        const on = mobile
          ? "bg-white/10 border-jeep/30 text-white"
          : "bg-white/5 border-jeep/30";
        const off = mobile
          ? "bg-dark-950 border-white/10 text-slate-300 hover:text-white hover:bg-white/5"
          : "bg-dark-950";
        const cls = `${base} ${active ? on : off}`;
        const left = mobile
          ? `<i class="fa-solid ${icon(sec.id)} text-jeep"></i><span>${escapeHtml(sec.name.split("‚Äî")[0].trim())}</span>`
          : `<div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 rounded-xl bg-dark-900 border border-white/10 flex items-center justify-center text-slate-300">
                  <i class="fa-solid ${icon(sec.id)}"></i>
                </div>
                <div class="min-w-0">
                  <div class="text-sm font-display font-bold text-white truncate">${escapeHtml(sec.name)}</div>
                  <div class="text-[10px] text-slate-500 truncate">${escapeHtml(sec.subtitle)}</div>
                </div>
              </div>`;
        const right = mobile ? "" : `<i class="fa-solid fa-chevron-right text-slate-600"></i>`;
        return `<button class="${cls}" data-camp-nav="${sec.id}">${left}${right}</button>`;
      };

      const kpiCard = (k) => `
        <div class="glass-card rounded-2xl p-5 border border-white/5">
          <div class="text-[10px] uppercase font-black tracking-widest text-slate-500">${escapeHtml(k.label)}</div>
          <div class="mt-1 text-2xl font-display font-black text-white tracking-tight">${escapeHtml(k.value)}</div>
          <div class="mt-1 text-xs text-slate-500">${escapeHtml(k.note||"")}</div>
        </div>
      `;

      const ruleRow = (r, idx) => {
        const compact = state.mode === "compacto";
        const dCls = compact ? "text-xs text-slate-500 leading-relaxed" : "text-sm text-slate-300 leading-relaxed";
        return `
          <div class="p-4 rounded-2xl bg-dark-950 border border-white/5">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-display font-bold text-white">${escapeHtml(r.t)}</div>
                <div class="mt-1 ${dCls}">${escapeHtml(r.d)}</div>
              </div>
              <div class="text-[10px] font-mono text-slate-600">#${String(idx+1).padStart(2,"0")}</div>
            </div>
          </div>
        `;
      };

      const premioCard = (p) => `
        <div class="glass-card rounded-2xl p-5 border border-white/5">
          <div class="text-sm font-display font-bold text-white">${escapeHtml(p.title)}</div>
          <div class="mt-1 text-xl font-display font-black text-jeep">${escapeHtml(p.value)}</div>
          <div class="mt-1 text-xs text-slate-500 leading-relaxed">${escapeHtml(p.detail||"")}</div>
        </div>
      `;

      const timelineItem = (t) => `
        <div class="flex gap-3">
          <div class="flex flex-col items-center">
            <div class="w-2.5 h-2.5 rounded-full bg-jeep"></div>
            <div class="w-px flex-1 bg-white/10"></div>
          </div>
          <div class="pb-2">
            <div class="text-[10px] uppercase font-black tracking-widest text-slate-600">${escapeHtml(t.when)}</div>
            <div class="text-sm font-display font-bold text-white">${escapeHtml(t.what)}</div>
            <div class="text-xs text-slate-500">${escapeHtml(t.how||"")}</div>
          </div>
        </div>
      `;

      const setMode = (mode) => {
        state.mode = mode === "compacto" ? "compacto" : "detalhado";
        localStorage.setItem(KEY_MODE, state.mode);
        const onCls = "px-3 py-1.5 rounded-xl text-xs font-black uppercase tracking-wider bg-jeep text-black border border-jeep/50";
        const offCls = "px-3 py-1.5 rounded-xl text-xs font-black uppercase tracking-wider bg-white/5 hover:bg-white/10 transition border border-white/10 text-white";
        $("campBtnCompact").className = (state.mode === "compacto") ? onCls : offCls;
        $("campBtnDetalhado").className = (state.mode === "detalhado") ? onCls : offCls;
      };

      const setActive = (id) => {
        if (!CAMP.sectors.some(s => s.id === id)) return;
        state.activeId = id;
        localStorage.setItem(KEY_ACTIVE, id);
        render();
      };

      const renderNav = () => {
        const nav = $("campNav");
        const navM = $("campNavMobile");
        if (nav) nav.innerHTML = CAMP.sectors.map(s => navButton(s, s.id === state.activeId)).join("");
        if (navM) navM.innerHTML = CAMP.sectors.map(s => navButton(s, s.id === state.activeId, true)).join("");

        const bind = (root) => {
          if (!root) return;
          root.querySelectorAll("[data-camp-nav]").forEach(btn => {
            btn.addEventListener("click", () => setActive(btn.getAttribute("data-camp-nav")));
          });
        };
        bind(nav);
        bind(navM);
      };

      const render = () => {
        const sec = CAMP.sectors.find(s => s.id === state.activeId) || CAMP.sectors[0];
        if (!sec) return;

        const label = $("campActiveIdLabel");
        if (label) label.textContent = sec.id;

        $("campSectorTitle").textContent = sec.name;
        $("campSectorSubtitle").textContent = sec.subtitle;

        $("campBadges").innerHTML = (sec.badges||[]).map(badge).join("");
        $("campKpiGrid").innerHTML = (sec.kpis||[]).map(kpiCard).join("");

        const rulesAll = sec.rules || [];
        const rules = rulesAll.filter(r => applySearch(`${r.t} ${r.d}`));
        $("campRulesCount").textContent = `${rules.length}/${rulesAll.length}`;
        $("campRulesList").innerHTML = rules.map(ruleRow).join("");

        const premiosAll = sec.premios || [];
        const premios = premiosAll.filter(p => applySearch(`${p.title} ${p.value} ${p.detail||""}`));
        $("campPremiosHint").textContent = `${premios.length}/${premiosAll.length}`;
        $("campPremiosGrid").innerHTML = premios.map(premioCard).join("");

        const tlAll = sec.timeline || [];
        const tl = tlAll.filter(t => applySearch(`${t.when} ${t.what} ${t.how||""}`));
        $("campTimeline").innerHTML = tl.map(timelineItem).join("");

        const extrasBox = $("campExtrasBox");
        if (extrasBox) extrasBox.classList.toggle("hidden", state.mode === "compacto");
        $("campExtrasList").innerHTML = (sec.extras||[]).filter(x => applySearch(x))
          .map(x => `<li>‚Ä¢ ${escapeHtml(x)}</li>`).join("");

        $("campFooterLeft").textContent = `Setor: ${sec.name} ‚Ä¢ Per√≠odo: ${CAMP.q.start} a ${CAMP.q.end}`;

        renderNav(); // keep nav states in sync
      };

      const init = () => {
        // elements must exist (tab inserted)
        if (!$("campSectorTitle")) return;

        setMode(state.mode);

        $("campSearchInput").addEventListener("input", (e) => {
          state.search = e.target.value || "";
          render();
        });

        $("campBtnCompact").addEventListener("click", () => { setMode("compacto"); render(); });
        $("campBtnDetalhado").addEventListener("click", () => { setMode("detalhado"); render(); });

        $("campBtnCopyResumo").addEventListener("click", async () => {
          const sec = CAMP.sectors.find(s => s.id === state.activeId) || CAMP.sectors[0];
          const lines = [];
          lines.push(`${sec.name} ‚Äî ${sec.subtitle}`);
          lines.push(`Per√≠odo: ${CAMP.q.start} a ${CAMP.q.end}`);
          lines.push("");
          lines.push("KPIs:");
          (sec.kpis||[]).forEach(k => lines.push(`- ${k.label}: ${k.value} (${k.note||""})`));
          lines.push("");
          lines.push("Regras:");
          (sec.rules||[]).forEach((r,i) => lines.push(`- [${i+1}] ${r.t}: ${r.d}`));
          lines.push("");
          lines.push("Premia√ß√£o:");
          (sec.premios||[]).forEach(p => lines.push(`- ${p.title}: ${p.value} ‚Äî ${p.detail||""}`));
          lines.push("");
          lines.push("Calend√°rio:");
          (sec.timeline||[]).forEach(t => lines.push(`- ${t.when}: ${t.what} (${t.how||""})`));
          const text = lines.join("\n").trim();

          try {
            await navigator.clipboard.writeText(text);
            toast("Resumo copiado!");
          } catch {
            toast("N√£o consegui copiar automaticamente.");
          }
        });

        $("campBtnPrint").addEventListener("click", () => window.print());

        renderNav();
        render();
      };

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>

</body>
</html>
